<!DOCTYPE html> 
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>CHANGE TITLE HERE</title>



<style type="text/css">
    svg { 
		display: block;
		margin: auto;
	}
</style>
</head>

<body>

	<script type="text/javascript" src="libs/d3.v4.min.js"></script>
	<script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

	<p>
  		<label for="nSlider" style="display: inline-block; width: 240px; text-align: right"> 
  			Year: <span id="nYear-value">â€¦</span>
  		</label>
  		<input type="range" min="1" max="1000" id="nSlider">
	</p>

	<div id="vizContainer"></div>

	<script type="text/javascript">
		var improvedWaterSourceData;
		var fertilityRateData;
		var infantMortalityData;
		var maternalMortalityData;
		var primaryCompletionData;

		var allData = [];

		var currentVisibleDataAbove;
		var currentVisibleDataBelow;

		var width = 800;
		var height = 800;
		var svgCanvas;

		function getCountriesData(data) {
			var countriesData = d3.nest()
			 	.key(function(d) {
			 		return d["Country Code"];
				})
				.rollup(function(d) {
					var dataEntries = d3.map(d[0]).entries();

					var years = d3.map();
					var meta = d3.map();

					for (var i = 0; i < dataEntries.length; i++) {
						if (!isNaN(parseInt(dataEntries[i].key))) {
							if (parseInt(dataEntries[i].key) >= 1990 && parseInt(dataEntries[i].key) <= 2014) {
								if (!isNaN(parseFloat(dataEntries[i].value))) {
									years.set(parseInt(dataEntries[i].key), parseFloat(dataEntries[i].value));
								}
							}
						} else {
							meta.set(dataEntries[i].key, dataEntries[i].value);
						}
					}

					return {
						"years": years,
						"meta": meta
					}
				})
				.map(data);

			return countriesData;
		}

		d3.csv("data/improved_water_source.csv", function(data) {
			improvedWaterSourceData = getCountriesData(data)["$TSS"];

			d3.csv("data/fertility_rate.csv", function(data) {
				fertilityRateData = getCountriesData(data)["$TSS"];

				d3.csv("data/infant_mortality_rate.csv", function(data) {
					infantMortalityData = getCountriesData(data)["$TSS"];
					
					d3.csv("data/maternal_mortality_rate.csv", function(data) {
						maternalMortalityData = getCountriesData(data)["$TSS"];

						d3.csv("data/primary_completion_rate.csv", function(data) {
							primaryCompletionData = getCountriesData(data)["$TSS"];

							console.log(primaryCompletionData);
							
							allData = [
								[maternalMortalityData, improvedWaterSourceData],
								[infantMortalityData, improvedWaterSourceData],
								[fertilityRateData, infantMortalityData],
								[fertilityRateData, improvedWaterSourceData],
								[primaryCompletionData, improvedWaterSourceData]
							];

							drawCanvas();
						});
					});
				});
			});
		});

		var arcAbove = d3.arc()
				.innerRadius(0)
			    .outerRadius(20)
			    .startAngle(-90 * (Math.PI/180))
			    .endAngle(90 * (Math.PI/180));

		var arcBelow = d3.arc()
				.innerRadius(0)
			    .outerRadius(20)
			    .startAngle(90 * (Math.PI/180))
			    .endAngle(270 * (Math.PI/180));

		var currentDataIndex = 0;

		function drawCanvas() {
			svgCanvas = d3.select("#vizContainer").append("svg") 
				.attrs({
					width: width,
					height: height
				});

			d3.select("#nSlider").on("input", function() {
	  			update(+this.value, currentVisibleDataAbove, currentVisibleDataBelow);
			});

		    svgCanvas.append("path")
		    	.attrs({
		    		d: arcAbove,
		    		transform: "translate(400,300)",
		    		id: "arc1"
		    	});

		    svgCanvas.append("path")
		    	.attrs({
		    		d: arcBelow,
		    		transform: "translate(400,320)",
		    		id: "arc2"
		    	});

            d3.select("body").append("button")
                .text("back")
                .attrs({
                	id: "back-button"
                })
                .on("click", function() {
                	if (currentDataIndex != 0) {
                		currentDataIndex--;
                		update(1, allData[currentDataIndex][0], allData[currentDataIndex][1]);
                	}
                });
            d3.select("body").append("button")
                .text("next")
                .attrs({
                	id: "next-button"
                })
                .on("click", function() {
                    if (currentDataIndex != 4) {
                		currentDataIndex++;
                		update(1, allData[currentDataIndex][0], allData[currentDataIndex][1]);
                	}
                });

		    update(1, allData[0][0], allData[0][1]);
		}

		function update(sliderValue, visibleDataAbove, visibleDataBelow) {
			currentVisibleDataBelow = visibleDataBelow;
			currentVisibleDataAbove = visibleDataAbove;

			var years = visibleDataBelow.years.keys();
			for (var i=0; i < years.length; i++) {
				years[i] = parseInt(years[i]);
			}

			var sliderScale = d3.scaleQuantize()
				.domain([1, 1000])
				.range(years);

			var selectedYear = sliderScale(sliderValue);
			d3.select("#nYear-value").text(selectedYear);
			d3.select("#nSlider").property("value", sliderValue);

			var minRadius = 20;
			var maxRadius = 250;

			var minAbove = d3.min(visibleDataAbove.years.values());
			var maxAbove = d3.max(visibleDataAbove.years.values());
			var radiusScaleAbove = d3.scaleLinear().domain([minAbove, maxAbove]).range([minRadius, maxRadius]);

			var minBelow = d3.min(visibleDataBelow.years.values());
			var maxBelow = d3.max(visibleDataBelow.years.values());
			var radiusScaleBelow = d3.scaleLinear().domain([minBelow, maxBelow]).range([minRadius, maxRadius]);

			arcAbove.outerRadius(radiusScaleAbove(visibleDataAbove.years["$"+selectedYear]));
			d3.select("#arc1").transition()
				.duration(500)
				.attr("d", arcAbove);

			arcBelow.outerRadius(radiusScaleBelow(visibleDataBelow.years["$"+selectedYear]));
			d3.select("#arc2").transition()
				.duration(500)
				.attr("d", arcBelow);
		}
		

	</script>
</body>
</html>
